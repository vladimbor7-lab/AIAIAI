<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Travel AI ‚Äî –ü–∞–Ω–µ–ª—å –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
<style>
:root{
  --c1:#0f172a;--c2:#1e293b;
  --a:#2563eb;--a2:#3b82f6;--at:rgba(37,99,235,.1);
  --g:#f8fafc;--g2:#f1f5f9;--g3:#e2e8f0;
  --tx:#0f172a;--tx2:#475569;--tx3:#94a3b8;--wh:#fff;
  --green:#16a34a;--greent:rgba(22,163,74,.08);
  --red:#dc2626;--redt:rgba(220,38,38,.08);
  --font:'Inter',-apple-system,sans-serif;--rd:12px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:var(--font);background:var(--g);color:var(--tx);-webkit-font-smoothing:antialiased;}

/* LAYOUT */
.layout{display:flex;min-height:100svh;}

/* SIDEBAR */
.sidebar{width:240px;background:var(--c1);display:flex;flex-direction:column;flex-shrink:0;position:fixed;top:0;left:0;bottom:0;z-index:50;}
.sb-logo{padding:20px 20px 16px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px;}
.sb-logo-mark{width:32px;height:32px;background:var(--a);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:15px;flex-shrink:0;}
.sb-logo-text{font-size:16px;font-weight:700;color:#fff;letter-spacing:-.3px;}
.sb-logo-text span{color:var(--a2);}

.sb-agency{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);}
.sb-ag-label{font-size:10px;font-weight:600;color:rgba(255,255,255,.3);letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px;}
.sb-ag-name{font-size:14px;font-weight:600;color:#fff;}
.sb-plan{display:inline-block;margin-top:4px;font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:rgba(37,99,235,.2);color:var(--a2);}

.sb-nav{padding:12px 8px;flex:1;}
.sn{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:10px;font-size:13px;font-weight:500;color:rgba(255,255,255,.5);cursor:pointer;transition:all .15s;margin-bottom:2px;}
.sn:hover{background:rgba(255,255,255,.06);color:rgba(255,255,255,.8);}
.sn.active{background:rgba(37,99,235,.2);color:#fff;font-weight:600;}
.sn-ico{font-size:16px;width:20px;text-align:center;flex-shrink:0;}

.sb-bottom{padding:12px 8px;border-top:1px solid rgba(255,255,255,.06);}
.sb-logout{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:10px;font-size:13px;font-weight:500;color:rgba(255,255,255,.35);cursor:pointer;transition:all .15s;}
.sb-logout:hover{background:rgba(255,255,255,.04);color:rgba(255,255,255,.6);}

/* MAIN */
.main{margin-left:240px;flex:1;display:flex;flex-direction:column;min-height:100svh;}
.topbar{background:#fff;border-bottom:1px solid var(--g3);padding:0 32px;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40;}
.topbar-title{font-size:16px;font-weight:700;color:var(--tx);}
.topbar-right{display:flex;align-items:center;gap:12px;}
.badge-live{display:flex;align-items:center;gap:5px;font-size:12px;font-weight:600;color:var(--green);}
.dot-live{width:7px;height:7px;border-radius:50%;background:var(--green);animation:bl 2s infinite;}
@keyframes bl{0%,100%{opacity:1;}50%{opacity:.3;}}

.content{padding:28px 32px;flex:1;}

/* TABS */
.tabs{display:flex;gap:2px;background:var(--g2);border-radius:12px;padding:3px;width:fit-content;margin-bottom:24px;}
.tab{padding:8px 16px;border-radius:10px;font-size:13px;font-weight:600;color:var(--tx3);cursor:pointer;transition:all .15s;}
.tab.active{background:#fff;color:var(--tx);box-shadow:0 1px 3px rgba(0,0,0,.07);}

/* STATS ROW */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
.stat-card{background:#fff;border:1.5px solid var(--g3);border-radius:var(--rd);padding:18px 20px;}
.sc-label{font-size:12px;color:var(--tx3);font-weight:500;margin-bottom:8px;}
.sc-val{font-size:28px;font-weight:800;color:var(--tx);letter-spacing:-1px;line-height:1;}
.sc-val.blue{color:var(--a);}
.sc-val.green{color:var(--green);}
.sc-delta{font-size:11px;color:var(--green);font-weight:600;margin-top:4px;}

/* LEADS */
.leads-wrap{background:#fff;border:1.5px solid var(--g3);border-radius:var(--rd);overflow:hidden;}
.leads-hdr{padding:16px 20px;border-bottom:1px solid var(--g3);display:flex;align-items:center;justify-content:space-between;}
.leads-title{font-size:14px;font-weight:700;color:var(--tx);}
.leads-count{font-size:12px;color:var(--tx3);}
.lead-row{padding:14px 20px;border-bottom:1px solid var(--g3);display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;align-items:center;transition:background .15s;}
.lead-row:last-child{border-bottom:none;}
.lead-row:hover{background:var(--g);}
.lead-name{font-size:14px;font-weight:600;color:var(--tx);}
.lead-params{font-size:12px;color:var(--tx3);margin-top:2px;}
.lead-dest{font-size:13px;color:var(--tx2);}
.lead-budget{font-size:13px;font-weight:700;color:var(--a);}
.lead-status{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;}
.lead-status.hot{background:rgba(220,38,38,.08);color:#dc2626;}
.lead-status.new{background:var(--at);color:var(--a);}
.lead-status.done{background:var(--greent);color:var(--green);}
.lead-actions{display:flex;gap:6px;}
.la{padding:5px 10px;border-radius:7px;font-size:11px;font-weight:700;border:none;cursor:pointer;font-family:var(--font);transition:all .15s;}
.la.call{background:var(--greent);color:var(--green);border:1px solid rgba(22,163,74,.2);}
.la.call:hover{background:rgba(22,163,74,.15);}
.la.msg{background:var(--g2);color:var(--tx2);border:1px solid var(--g3);}
.la.msg:hover{background:var(--g3);}

.empty-state{padding:60px 20px;text-align:center;}
.empty-ico{font-size:40px;margin-bottom:12px;}
.empty-title{font-size:16px;font-weight:700;color:var(--tx);margin-bottom:6px;}
.empty-sub{font-size:13px;color:var(--tx3);}

/* SETTINGS */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.scard{background:#fff;border:1.5px solid var(--g3);border-radius:var(--rd);padding:24px;}
.scard.full{grid-column:1/-1;}
.scard-title{font-size:14px;font-weight:700;color:var(--tx);margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--g3);}
.fld{display:flex;flex-direction:column;gap:5px;margin-bottom:14px;}
.fld label{font-size:11px;font-weight:700;color:var(--tx3);letter-spacing:.3px;text-transform:uppercase;}
.fld input,.fld select,.fld textarea{background:var(--g);border:1.5px solid var(--g3);border-radius:10px;padding:10px 13px;font-family:var(--font);font-size:13px;color:var(--tx);outline:none;transition:border .15s;-webkit-appearance:none;}
.fld input:focus,.fld select:focus,.fld textarea:focus{border-color:var(--a);background:#fff;}
.fld input::placeholder,.fld textarea::placeholder{color:var(--tx3);}
.fld textarea{resize:vertical;min-height:80px;}
.fld select option{background:#fff;}
.save-btn{padding:10px 22px;background:var(--a);color:#fff;border:none;border-radius:9px;font-family:var(--font);font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;}
.save-btn:hover{background:#1d4ed8;}
.save-btn:disabled{opacity:.5;cursor:not-allowed;}

/* WIDGET */
.widget-box{background:var(--g);border:1.5px solid var(--g3);border-radius:10px;padding:14px;font-size:12px;color:var(--tx2);font-family:monospace;line-height:1.7;word-break:break-all;position:relative;}
.copy-btn{position:absolute;top:10px;right:10px;padding:4px 10px;background:#fff;border:1px solid var(--g3);border-radius:6px;font-size:11px;font-weight:600;color:var(--tx3);cursor:pointer;font-family:var(--font);transition:all .15s;}
.copy-btn:hover{color:var(--a);border-color:var(--a);}

.sp{display:inline-block;width:13px;height:13px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;margin-right:6px;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg);}}
.ssp{display:inline-block;width:13px;height:13px;border:2px solid rgba(37,99,235,.2);border-top-color:var(--a);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;}

@media(max-width:900px){
  .sidebar{display:none;}
  .main{margin-left:0;}
  .stats-row{grid-template-columns:1fr 1fr;}
  .lead-row{grid-template-columns:1fr;gap:6px;}
  .settings-grid{grid-template-columns:1fr;}
  .content{padding:16px;}
}
</style>
</head>
<body>

<div class="layout">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sb-logo">
      <div class="sb-logo-mark">T</div>
      <div class="sb-logo-text">Travel<span>AI</span></div>
    </div>
    <div class="sb-agency">
      <div class="sb-ag-label">–ê–≥–µ–Ω—Ç—Å—Ç–≤–æ</div>
      <div class="sb-ag-name" id="sbName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div class="sb-plan" id="sbPlan">Pro</div>
    </div>
    <div class="sb-nav">
      <div class="sn active" onclick="showTab('leads')"><span class="sn-ico">üìã</span>–ó–∞—è–≤–∫–∏</div>
      <div class="sn" onclick="showTab('settings')"><span class="sn-ico">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div class="sn" onclick="showTab('widget')"><span class="sn-ico">üåê</span>–í–∏–¥–∂–µ—Ç</div>
      <div class="sn" onclick="showTab('stats')"><span class="sn-ico">üìä</span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
    </div>
    <div class="sb-bottom">
      <div class="sb-logout" onclick="logout()"><span class="sn-ico">‚Üê</span>–í—ã–π—Ç–∏</div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <div class="topbar-title" id="topTitle">–ó–∞—è–≤–∫–∏</div>
      <div class="topbar-right">
        <div class="badge-live"><span class="dot-live"></span>–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω</div>
      </div>
    </div>

    <div class="content">

      <!-- LEADS TAB -->
      <div id="tabLeads">
        <div class="stats-row">
          <div class="stat-card"><div class="sc-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div><div class="sc-val blue" id="statTotal">‚Äî</div></div>
          <div class="stat-card"><div class="sc-label">–ì–æ—Ä—è—á–∏—Ö</div><div class="sc-val" style="color:#dc2626;" id="statHot">‚Äî</div></div>
          <div class="stat-card"><div class="sc-label">–ó–∞–∫—Ä—ã—Ç–æ</div><div class="sc-val green" id="statDone">‚Äî</div></div>
          <div class="stat-card"><div class="sc-label">–î–∏–∞–ª–æ–≥–æ–≤</div><div class="sc-val" id="statDialogs">‚Äî</div></div>
        </div>
        <div class="leads-wrap">
          <div class="leads-hdr">
            <div class="leads-title">–í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏</div>
            <div class="leads-count" id="leadsCount"></div>
          </div>
          <div id="leadsList">
            <div class="empty-state"><div class="ssp"></div></div>
          </div>
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div id="tabSettings" style="display:none;">
        <div class="settings-grid">
          <div class="scard">
            <div class="scard-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</div>
            <div class="fld"><label>–ò–º—è –±–æ—Ç–∞</label><input type="text" id="sBotName" placeholder="–†–æ–º–∞–Ω"></div>
            <div class="fld"><label>–¶–≤–µ—Ç –±—Ä–µ–Ω–¥–∞</label><input type="color" id="sBrandColor" value="#2563eb" style="height:42px;cursor:pointer;padding:4px;"></div>
            <div class="fld"><label>–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è</label>
              <select id="sTone">
                <option value="friendly">–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π</option>
                <option value="formal">–î–µ–ª–æ–≤–æ–π</option>
                <option value="casual">–ù–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π</option>
              </select>
            </div>
            <button class="save-btn" id="saveBotBtn" onclick="saveBot()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
          <div class="scard">
            <div class="scard-title">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
            <div class="fld"><label>–°—Ç—Ä–∞–Ω—ã –∏ –∫—É—Ä–æ—Ä—Ç—ã</label>
              <textarea id="sCountries" placeholder="–¢—É—Ä—Ü–∏—è, –ï–≥–∏–ø–µ—Ç, –û–ê–≠, –¢–∞–∏–ª–∞–Ω–¥..."></textarea>
            </div>
            <div class="fld"><label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</label>
              <textarea id="sInstructions" placeholder="–û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è, –∞–∫—Ü–∏–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è..."></textarea>
            </div>
            <button class="save-btn" onclick="saveBot()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
          <div class="scard full">
            <div class="scard-title">API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</div>
            <div class="fld"><label>Anthropic API Key</label><input type="password" id="sAnthropicKey" placeholder="sk-ant-api03-..."></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <div class="fld"><label>Sletat –ª–æ–≥–∏–Ω</label><input type="text" id="sSletatLogin" placeholder="your@email.com"></div>
              <div class="fld"><label>Sletat –ø–∞—Ä–æ–ª—å</label><input type="password" id="sSletatPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            </div>
            <button class="save-btn" onclick="saveBot()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
      </div>

      <!-- WIDGET TAB -->
      <div id="tabWidget" style="display:none;">
        <div class="scard" style="background:#fff;border:1.5px solid var(--g3);border-radius:var(--rd);padding:24px;max-width:600px;">
          <div class="scard-title">–ö–æ–¥ –≤–∏–¥–∂–µ—Ç–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞</div>
          <p style="font-size:13px;color:var(--tx2);margin-bottom:16px;line-height:1.6;">–í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ HTML –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞ ‚Äî –±–æ—Ç –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ. –†–∞–±–æ—Ç–∞–µ—Ç —Å Tilda, Wix, WordPress –∏ –ª—é–±—ã–º HTML.</p>
          <div class="widget-box" id="widgetCode">
            <button class="copy-btn" onclick="copyWidget()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <!-- –∫–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ -->
          </div>
          <p style="font-size:12px;color:var(--tx3);margin-top:12px;">–ë–µ–∑ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ ¬∑ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–º —Å–∞–π—Ç–µ ¬∑ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
        </div>
      </div>

      <!-- STATS TAB -->
      <div id="tabStats" style="display:none;">
        <div class="stats-row" style="grid-template-columns:repeat(3,1fr);">
          <div class="stat-card"><div class="sc-label">–í—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–æ–≤</div><div class="sc-val blue" id="st2Total">‚Äî</div></div>
          <div class="stat-card"><div class="sc-label">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ –∑–∞—è–≤–∫–∏</div><div class="sc-val green" id="st2Leads">‚Äî</div></div>
          <div class="stat-card"><div class="sc-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div><div class="sc-val" id="st2Conv">‚Äî</div></div>
        </div>
        <div class="scard" style="background:#fff;border:1.5px solid var(--g3);border-radius:var(--rd);padding:24px;">
          <div class="scard-title">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞</div>
          <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--tx2);margin-bottom:8px;">
            <span>–î–∏–∞–ª–æ–≥–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</span>
            <span id="usageText">‚Äî</span>
          </div>
          <div style="background:var(--g3);border-radius:10px;height:8px;overflow:hidden;">
            <div id="usageBar" style="height:100%;background:var(--a);border-radius:10px;width:0%;transition:width .5s;"></div>
          </div>
          <p style="font-size:12px;color:var(--tx3);margin-top:10px;">–õ–∏–º–∏—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è 1-–≥–æ —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞</p>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const API = 'https://roman-backend-production.up.railway.app';
let agencyKey = localStorage.getItem('travelai_key');
let agencyData = null;

if (!agencyKey) window.location.href = 'roman-login.html';

function logout() {
  localStorage.removeItem('travelai_key');
  window.location.href = 'roman-login.html';
}

function showTab(name) {
  ['leads','settings','widget','stats'].forEach(t => {
    document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).style.display = t===name?'':'none';
  });
  document.querySelectorAll('.sn').forEach((el,i) => {
    el.classList.toggle('active', ['leads','settings','widget','stats'][i]===name);
  });
  const titles = {leads:'–ó–∞—è–≤–∫–∏',settings:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏',widget:'–í–∏–¥–∂–µ—Ç',stats:'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'};
  document.getElementById('topTitle').textContent = titles[name];
  if (name==='leads') loadLeads();
  if (name==='stats') loadStats();
}

// LOAD CONFIG
async function loadConfig() {
  try {
    const res = await fetch(`${API}/api/agency/config`, { headers: {'x-agency-key': agencyKey} });
    if (res.status === 401) { logout(); return; }
    agencyData = await res.json();
    document.getElementById('sbName').textContent = agencyData.name || '–ê–≥–µ–Ω—Ç—Å—Ç–≤–æ';
    document.getElementById('sbPlan').textContent = (agencyData.plan||'Pro').charAt(0).toUpperCase()+(agencyData.plan||'pro').slice(1);
    document.getElementById('sBotName').value = agencyData.bot_name || '';
    document.getElementById('sBrandColor').value = agencyData.brand_color || '#2563eb';
    document.getElementById('sTone').value = agencyData.tone || 'friendly';
    document.getElementById('sCountries').value = agencyData.countries || '';
    document.getElementById('sInstructions').value = agencyData.custom_instructions || '';
    // Widget code
    const wc = `<iframe src="${API}/widget?key=${agencyKey}" width="100%" height="600" frameborder="0" style="border-radius:16px;"></iframe>`;
    document.getElementById('widgetCode').innerHTML = `<button class="copy-btn" onclick="copyWidget()">${copied?'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!':'–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'}</button>${wc}`;
    document.getElementById('widgetCode').dataset.code = wc;
  } catch(e) { console.error(e); }
}

let copied = false;
function copyWidget() {
  const code = document.getElementById('widgetCode').dataset.code;
  navigator.clipboard.writeText(code).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
    setTimeout(() => btn.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 2000);
  });
}

// LOAD LEADS
async function loadLeads() {
  try {
    const res = await fetch(`${API}/api/agency/leads`, { headers: {'x-agency-key': agencyKey} });
    const data = await res.json();
    const leads = data.leads || [];
    document.getElementById('leadsCount').textContent = `${leads.length} –∑–∞—è–≤–æ–∫`;
    document.getElementById('statTotal').textContent = leads.length;
    document.getElementById('statHot').textContent = leads.filter(l=>l.status==='new').length;
    document.getElementById('statDone').textContent = leads.filter(l=>l.status==='done').length;
    document.getElementById('statDialogs').textContent = agencyData?.dialogs_used || '‚Äî';

    if (!leads.length) {
      document.getElementById('leadsList').innerHTML = `
        <div class="empty-state">
          <div class="empty-ico">üì≠</div>
          <div class="empty-title">–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>
          <div class="empty-sub">–ö–∞–∫ —Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–∏—Ç —Ñ–æ—Ä–º—É ‚Äî –∑–∞—è–≤–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</div>
        </div>`;
      return;
    }

    document.getElementById('leadsList').innerHTML = leads.map(l => `
      <div class="lead-row">
        <div>
          <div class="lead-name">${l.session_id?.slice(0,8) || '–ö–ª–∏–µ–Ω—Ç'}</div>
          <div class="lead-params">${new Date(l.created_at).toLocaleString('ru',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})}</div>
        </div>
        <div class="lead-dest">${l.summary?.slice(0,60) || '‚Äî'}</div>
        <div>
          <span class="lead-status ${l.status==='new'?'hot':l.status==='done'?'done':'new'}">
            ${l.status==='new'?'–ù–æ–≤–∞—è':l.status==='done'?'–ó–∞–∫—Ä—ã—Ç–∞':'–í —Ä–∞–±–æ—Ç–µ'}
          </span>
        </div>
        <div class="lead-actions">
          <button class="la call">üìû</button>
          <button class="la msg">üí¨</button>
        </div>
      </div>`).join('');
  } catch(e) {
    document.getElementById('leadsList').innerHTML = `<div class="empty-state"><div class="empty-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div></div>`;
  }
}

// LOAD STATS
async function loadStats() {
  try {
    const res = await fetch(`${API}/api/agency/stats`, { headers: {'x-agency-key': agencyKey} });
    const data = await res.json();
    const total = data.total_sessions || 0;
    const leads = data.total_leads || 0;
    const conv = total ? Math.round(leads/total*100) : 0;
    document.getElementById('st2Total').textContent = total;
    document.getElementById('st2Leads').textContent = leads;
    document.getElementById('st2Conv').textContent = conv + '%';

    const used = agencyData?.dialogs_used || 0;
    const limit = agencyData?.dialogs_limit || 100;
    const pct = Math.min(used/limit*100, 100);
    document.getElementById('usageText').textContent = `${used} / ${limit}`;
    document.getElementById('usageBar').style.width = pct + '%';
    document.getElementById('usageBar').style.background = pct > 80 ? '#dc2626' : 'var(--a)';
  } catch(e) {}
}

// SAVE BOT
async function saveBot() {
  const btn = document.getElementById('saveBotBtn');
  if (btn) { btn.disabled = true; btn.innerHTML = '<span class="sp"></span>–°–æ—Ö—Ä–∞–Ω—è–µ–º...'; }
  try {
    await fetch(`${API}/api/agency/config`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', 'x-agency-key': agencyKey },
      body: JSON.stringify({
        bot_name: document.getElementById('sBotName').value,
        brand_color: document.getElementById('sBrandColor').value,
        tone: document.getElementById('sTone').value,
        countries: document.getElementById('sCountries').value,
        custom_instructions: document.getElementById('sInstructions').value,
        anthropic_key: document.getElementById('sAnthropicKey').value || undefined,
        sletat_login: document.getElementById('sSletatLogin').value || undefined,
        sletat_password: document.getElementById('sSletatPass').value || undefined,
      })
    });
    if (btn) { btn.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; setTimeout(() => { btn.disabled=false; btn.textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; }, 2000); }
  } catch(e) {
    if (btn) { btn.disabled=false; btn.textContent='–û—à–∏–±–∫–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ'; }
  }
}

// INIT
loadConfig().then(() => loadLeads());
</script>
</body>
</html>
